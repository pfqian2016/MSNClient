package com.android.mobilesocietynetwork.client.chat;

import java.io.File;
import java.io.IOException;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Iterator;
import java.util.List;

import com.android.mobilesocietynetwork.client.ActivityManager;
import com.android.mobilesocietynetwork.client.BaseActivity;
import com.android.mobilesocietynetwork.client.LoginActivity;
import com.android.mobilesocietynetwork.client.MainActivity;
import com.android.mobilesocietynetwork.client.MyActivity;
import com.android.mobilesocietynetwork.client.R;
import com.android.mobilesocietynetwork.client.database.BufferedUpMessageDB;
import com.android.mobilesocietynetwork.client.database.CommunityListDB;
import com.android.mobilesocietynetwork.client.database.MessageDB;
import com.android.mobilesocietynetwork.client.database.MultiUserChatDB;
import com.android.mobilesocietynetwork.client.database.OfflineMessageDB;
import com.android.mobilesocietynetwork.client.database.OfflineThrowTimeDB;
import com.android.mobilesocietynetwork.client.database.OnlineThrowTimeDB;
import com.android.mobilesocietynetwork.client.database.SharePreferenceUtil;
import com.android.mobilesocietynetwork.client.database.WaitToRecDB;
import com.android.mobilesocietynetwork.client.info.BufferMsgEntity;
import com.android.mobilesocietynetwork.client.info.ChatMsgEntity;
import com.android.mobilesocietynetwork.client.info.User;
import com.android.mobilesocietynetwork.client.info.hybrid.BeginAskOnlineInfo;
import com.android.mobilesocietynetwork.client.notice.CreateNoticeActivity;
import com.android.mobilesocietynetwork.client.packet.FileProcessPacket;
import com.android.mobilesocietynetwork.client.packet.hybrid.BeginAskOnlinePacket;
import com.android.mobilesocietynetwork.client.packet.hybrid.DirectScfPacket;
import com.android.mobilesocietynetwork.client.packet.hybrid.ForwardScfPacket;
import com.android.mobilesocietynetwork.client.tool.ReceiveNoticeIQTool;
import com.android.mobilesocietynetwork.client.tool.XmppTool;
import com.android.mobilesocietynetwork.client.util.Constants;
import com.android.mobilesocietynetwork.client.util.FileHelper;
import com.android.mobilesocietynetwork.client.util.MyDate;
import com.android.mobilesocietynetwork.client.util.NetworkSearchingWillingSP;
import com.android.mobilesocietynetwork.client.util.NetworkSpeedSP;
import com.android.mobilesocietynetwork.client.util.OfflineCost;
import com.android.mobilesocietynetwork.offline.MainService;

import com.msn.wqt.OfflineMsgEntity;
import com.msn.wqt.SendAPI;
import com.msn.wqt.WqtConstants;

import android.net.ConnectivityManager;
import android.net.NetworkInfo;
import android.net.Uri;
import android.os.Bundle;
import android.os.Environment;
import android.os.Handler;
import android.os.Build;
import android.os.Message;
import android.R.integer;
import android.app.Activity;
import android.app.AlertDialog;
import android.app.ProgressDialog;
import android.app.AlertDialog.Builder;
import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.DialogInterface;
import android.content.Intent;
import android.content.IntentFilter;
import android.graphics.Bitmap;
import android.graphics.BitmapFactory;
import android.util.Log;
import android.view.Menu;
import android.view.View;
import android.view.View.OnClickListener;
import android.view.Window;
import android.widget.Button;
import android.widget.EditText;
import android.widget.ListView;
import android.widget.TextView;
import android.widget.Toast;

import org.jivesoftware.smack.*;
import org.jivesoftware.smack.packet.Presence;
import org.jivesoftware.smack.util.StringUtils;
import org.jivesoftware.smackx.muc.DiscussionHistory;
import org.jivesoftware.smackx.muc.MultiUserChat;
import org.json.JSONObject;

public class DialogActivity extends BaseActivity {
	private TextView hint;
	private EditText content;
	private Button send, back, sendFile;
	private ListView mListView;
	private TextView mFriendName;
	private User user;
	private SharePreferenceUtil util;
	private ChatMsgViewAdapter mAdapter;// √è√ª√è¬¢√ä√ì√ç¬º¬µ√ÑAdapter
	private List<ChatMsgEntity> mDataArrays = new ArrayList<ChatMsgEntity>();// √è√ª√è¬¢¬∂√î√è√≥√ä√Ω√ó√©
	private MessageDB messageDB;
	private MultiUserChatDB multiUserChatDB;
	private BufferedUpMessageDB bufferDB;
	private OfflineThrowTimeDB offlineThrowTimeDB;
	private WaitToRecDB waitToRecDB;
	private OnlineThrowTimeDB onlineThrowTimeDB;
	private OfflineMessageDB offlineMessageDB;

	private OfflineCost oc;
	private NetworkSpeedSP netSpeedSP;
	private NetworkSearchingWillingSP netSeaWilAP;

	// private ChatManager cm;
	private Chat chat;
	private XMPPConnection con;
	private Roster roster;
	private MultiUserChat muc;
	private Presence presence;
	private int mode;
	private String forwarder;
	private ProgressDialog pd;
	private boolean flag;
	private String throwid;
	private String contenttext;
	private Builder builder = null;

	private NetworkchangeReceiver networkchangeReceiver;
	private boolean connected;
	private CommunityListDB communityListDB;

	@Override
	protected void onCreate(Bundle savedInstanceState) {
		super.onCreate(savedInstanceState);
		requestWindowFeature(Window.FEATURE_NO_TITLE);
		setContentView(R.layout.activity_dialog);
		ActivityManager exitM = ActivityManager.getInstance();
		exitM.addActivity(DialogActivity.this);

		user = (User) getIntent().getSerializableExtra("user");
		// user = new User();
		// user.setName("test");
		con = XmppTool.getConnection();
		roster = con.getRoster();
		util = new SharePreferenceUtil(this, Constants.SAVE_USER);
		messageDB = new MessageDB(this);
		bufferDB = new BufferedUpMessageDB(this);
		multiUserChatDB = MultiUserChatDB.getInstance();
		offlineThrowTimeDB = new OfflineThrowTimeDB(this);
		waitToRecDB = new WaitToRecDB(this);
		onlineThrowTimeDB = new OnlineThrowTimeDB(this);
		offlineMessageDB = new OfflineMessageDB(this);
		oc = new OfflineCost(util.getName());
		myApplication.setDirectTest(false);
		initView();
		initData();

		networkchangeReceiver = new NetworkchangeReceiver();
		// √ó¬¢¬≤√°√ç√∏√Ç√ß√Å¬¨¬Ω√ì√ó¬¥√å¬¨¬µ√Ñ¬π√£¬≤¬•¬£¬¨√ç√∏√Ç√ß√ó¬¥√å¬¨¬∏√Ñ¬±√§¬ª√°√ä√ï¬µ¬Ω¬π√£¬≤¬•
		IntentFilter intentFilter = new IntentFilter();
		intentFilter.addAction(ConnectivityManager.CONNECTIVITY_ACTION);
		registerReceiver(networkchangeReceiver, intentFilter);
	}

	/**
	 * ¬≥√µ√ä¬º¬ª¬Ø¬Ω√ß√É√¶
	 */
	public void initView() {
		mListView = (ListView) findViewById(R.id.listview);
		content = (EditText) findViewById(R.id.chat_editmessage);
		send = (Button) findViewById(R.id.chat_send);
		back = (Button) findViewById(R.id.chat_back);
		sendFile = (Button) findViewById(R.id.chat_sendfile);
		hint = (TextView) findViewById(R.id.tvHint);
		mListView = (ListView) findViewById(R.id.listview);
		mFriendName = (TextView) findViewById(R.id.chat_name);
		mFriendName.setText(user.getName());
		if (user.isCom() == true) {
			// muc = multiUserChatDB.findMuc(user.getName());
			// muc.addMessageListener(new multiListener());
			if (XmppTool.getConnection().isConnected()) {
				communityListDB = CommunityListDB.getInstance(DialogActivity.this);
				String password = communityListDB.qureyPassword(util.getName(), user.getName());
				muc = entryMultiUserChat(user.getName(), password);
			}
		} else {
			ChatManager cm = initChatManager();
			// 1104 modify
			// chat = cm.createChat(user.getName() + "@wss-pc", null);
			chat = cm.createChat(user.getName() + "@openfire", null);
		}
		send.setOnClickListener(new SendListener());
		back.setOnClickListener(new BackListener());
		sendFile.setOnClickListener(new OnClickListener() {

			@Override
			public void onClick(View arg0) {
				// TODO Auto-generated method stub
				builder = new AlertDialog.Builder(DialogActivity.this);
				View l = getLayoutInflater().inflate(R.layout.file_choose, null);
				builder.setTitle("Œƒº˛∏Ò Ω").setView(l).setNegativeButton("»°   œ˚", new DialogInterface.OnClickListener() {

					@Override
					public void onClick(DialogInterface dialog, int which) {
						// TODO Auto-generated method stub

					}
				}).show();
			/*	TextView picture = (TextView) l.findViewById(R.id.picture);
				TextView camera = (TextView) l.findViewById(R.id.camera);
				TextView music = (TextView) l.findViewById(R.id.music);
				TextView video = (TextView) l.findViewById(R.id.video);*/
				TextView file = (TextView) l.findViewById(R.id.file);
				/*picture.setOnClickListener(new filechooserlistener(R.id.picture));
				camera.setOnClickListener(new filechooserlistener(R.id.camera));
				music.setOnClickListener(new filechooserlistener(R.id.music));
				video.setOnClickListener(new filechooserlistener(R.id.video));*/
				file.setOnClickListener(new filechooserlistener(R.id.file));
			}
		});
	}

	// 1116 add
	/***************************** Œƒº˛¥´ ‰ µœ÷ *************************************************/
	class filechooserlistener implements OnClickListener {
		private int id;

		public filechooserlistener(int r) {
			this.id = r;
		}

		@Override
		public void onClick(View v) {
			// TODO Auto-generated method stub
			Intent i;
			switch (id) {
		/*	case R.id.picture:
				i = new Intent();
				i.setType("image/*");
				i.setAction(Intent.ACTION_GET_CONTENT);
				startActivityForResult(i, 0);
				break;
			case R.id.camera:
				String state = Environment.getExternalStorageState();
				if (state.equals(Environment.MEDIA_MOUNTED)) {
					i = new Intent("android.media.action.IMAGE_CAPTURE");
					startActivityForResult(i, 1);
				} else {
					Toast.makeText(DialogActivity.this, "Œﬁabcd", Toast.LENGTH_LONG).show();
				}
				break;
			case R.id.music:
				i = new Intent();
				i.setType("audio/*");
				i.setAction(Intent.ACTION_GET_CONTENT);
				startActivityForResult(i, 2);
				break;
			case R.id.video:
				i = new Intent();
				i.setType("video/*");
				i.setAction(Intent.ACTION_GET_CONTENT);
				startActivityForResult(i, 3);
				break;*/
			case R.id.file:
				i = new Intent();
				i.setType("file/*");
				i.setAction(Intent.ACTION_GET_CONTENT);
				startActivityForResult(i, 4);
				break;
			}
		}
	}

	@Override
	protected void onActivityResult(int requestCode, int resultCode, Intent data) {
		// TODO Auto-generated method stub
		super.onActivityResult(requestCode, resultCode, data);
		Uri uri;
		if (resultCode == Activity.RESULT_OK) {
			switch (requestCode) {
			case 0:
				uri = data.getData();

				break;
			case 1:
				Bitmap photo = null;
				uri = data.getData();
				if (uri != null) {
					photo = BitmapFactory.decodeFile(uri.getPath());

				}
				if (photo == null) {
					Bundle bundle = data.getExtras();
					if (bundle != null) {
						photo = (Bitmap) bundle.get("data");

					} else {
						Toast.makeText(DialogActivity.this, "no picture", Toast.LENGTH_SHORT).show();
						return;
					}
				}
				break;
			case 2:
				break;
			case 3:
				break;
			case 4:
				uri = data.getData();
				String path=uri.getPath();
				String suffix=path.split("\\.")[1];
				File file = new File(uri.getPath());
				String fileString = FileHelper.bytes2String(FileHelper.file2bytes(file));
				
				
				//split the String
				int n= 300000;
				
				int total= fileString.length()/n+1;
				//test
				//int total=2;
				String[] sub=new String[total];
			
				for(int i=0;i<total;i++){
					
					if(i==total-1){
						sub[i]=fileString.substring(n*i+0,n*i+fileString.length()%n);
					}else {
						sub[i]=fileString.substring(n*i+0,n*i+300000);
					}
	
					FileProcessPacket fileProcessPacket = new FileProcessPacket();
					fileProcessPacket.setFile(sub[i]);
					//test
					//fileProcessPacket.setFile("123");
					
					fileProcessPacket.setSource(util.getName());
					fileProcessPacket.setDestination(user.getName());
					fileProcessPacket.setCurrent(""+i);
					fileProcessPacket.setTotal(""+total);
					fileProcessPacket.setSuffix(suffix);
					XmppTool.getConnection().sendPacket(fileProcessPacket);
					try {
						Thread.sleep(200);
					} catch (InterruptedException e) {
						// TODO Auto-generated catch block
						e.printStackTrace();
					}
				}
				
				
			
				break;
			}
		}
	}

/*	protected boolean receiveFileResult() {
		int count = 0;
		while (ReceiveNoticeIQTool.getResult() == null && count < 20) {
			try {
				Thread.sleep(500);
				count++;
			} catch (InterruptedException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
		}
		if ("1".equals(ReceiveNoticeIQTool.getResult())) {

			return true;
		} else {
			return false;
		}

	}*/

	// 1104 add
	protected ChatManager initChatManager() {
		ChatManager c = con.getChatManager();
		c.addChatListener(new ChatManagerListener() {
			@Override
			public void chatCreated(Chat chat, boolean able) {
				chat.addMessageListener(new MessageListener() {
					@Override
					public void processMessage(Chat chat, org.jivesoftware.smack.packet.Message message) {
						String[] names = message.getFrom().split("@");
						ChatMsgEntity entity = new ChatMsgEntity(user.getName(), MyDate.getDateEN(), message.getBody(),
								util.getImg(), true);
						if (message.getBody() != null && message.getFrom().contains(user.getName())) {
							messageDB.saveMsg(user.getName(), entity);
							mDataArrays.add(entity);
							mAdapter.notifyDataSetChanged();
							// mListView.setSelection(mListView.getCount() - 1);
						} else if (message.getBody() != null) {
							messageDB.saveMsg(user.getName(), entity);// ¬±¬£¬¥√¶¬µ¬Ω√ä√Ω¬æ√ù¬ø√¢
							Toast.makeText(DialogActivity.this,
									"√Ñ√∫√ì√ê√ê√Ç¬µ√Ñ√è√ª√è¬¢√Ä¬¥√ó√î¬£¬∫" + message.getFrom() + ":" + message.getBody(), 0).show();// √Ü√§√ã√ª¬∫√É√ì√ë¬µ√Ñ√è√ª√è¬¢¬£¬¨¬æ√ç√è√à√å√°√ä¬æ¬£¬¨¬≤¬¢¬±¬£¬¥√¶¬µ¬Ω√ä√Ω¬æ√ù¬ø√¢
						}
					}

				});
			}
		});
		return c;
	}

	/**
	 * ¬≥√µ√ä¬º¬ª¬Ø√ä√Ω¬æ√ù
	 */
	public void initData() {
		String name = null;
		String userName = user.getName();
		int atIndex = userName.indexOf(WqtConstants.SYMBOL_SPILT);
		if (atIndex == -1) {
			name = userName;
		} else {
			name = userName.substring(0, atIndex);
		}
		List<ChatMsgEntity> list = messageDB.getMsg(util.getName(), name);
		mode = 0;
		flag = true;
		throwid = (int) (Math.random() * 1000) + "";
		if (list.size() > 0) {
			for (ChatMsgEntity entity : list) {
				if (entity.getImg() < 0) {
					entity.setImg(user.getImg());
				}
				mDataArrays.add(entity);
			}
			Collections.reverse(mDataArrays);
		}
		mAdapter = new ChatMsgViewAdapter(this, mDataArrays);
		mListView.setAdapter(mAdapter);
		mListView.setSelection(mAdapter.getCount() - 1);
	}

	/**
	 * ¬µ¬•¬≤¬•√ê√®√í¬™¬≥√µ√ä¬º¬ª¬Ø√Ç¬∑√ì√â√Ñ¬£√ä¬Ω¬£¬∫
	 * OnlineSelectMode√ä√á√Å¬™√ç√∏√á√©¬ø√∂√è√Ç√ç¬®¬π√Ω¬∑√æ√é√±√Ü√∑√ê¬≠√ñ√∫√ç√™¬≥√â√Ö√ê¬∂√è¬£¬ª
	 * OfflineSelectMode√ä√á√ç¬®¬π√Ω√ó√î¬º¬∫¬±¬æ¬µ√ò¬µ√Ñ√ä√Ω¬æ√ù¬ø√¢√Ä¬¥√ç√™¬≥√â√Ö√ê¬∂√è¬£¬ª
	 * 
	 * mode√ñ¬µ√ã¬µ√É√∑¬£¬∫ mode = 0¬£¬∫√ã¬´¬∑¬Ω¬∂¬º√î√ö√è√ü¬£¬¨√ñ¬±¬Ω√ì¬∑¬¢√ã√ç¬£¬ª mode =
	 * 1¬£¬∫¬∑¬¢√ã√ç¬∑¬Ω√î√ö√è√ü¬£¬¨¬Ω√ì√ä√ï¬∑¬Ω¬≤¬ª√î√ö√è√ü¬£¬¨¬∑√æ√é√±√Ü√∑¬ª¬∫¬¥√¶√è√ª√è¬¢¬£¬¨√ñ¬±¬Ω√ì¬∏√∏¬Ω√ì√ä√ï¬∑¬Ω mode =
	 * 2¬£¬∫¬∑¬¢√ã√ç¬∑¬Ω√î√ö√è√ü¬£¬¨¬Ω√ì√ä√ï¬∑¬Ω¬≤¬ª√î√ö√è√ü¬£¬¨¬∑√æ√é√±√Ü√∑√ë¬°√î√±√í¬ª¬∏√∂√î√ö√è√ü¬µ√Ñ√ñ√ê√ó¬™√ï√üSCF mode =
	 * 3¬£¬∫√ñ¬±¬Ω√ìSCF mode = 4¬£¬∫¬∑¬¢√ã√ç¬∑¬Ω¬≤¬ª√î√ö√è√ü¬£¬¨¬ª¬∫¬¥√¶¬µ√à√â√è√è√ü√ä¬±¬∑¬¢√ã√ç
	 * 
	 */
	private void OfflineSelectMode() {
		// TODO Auto-generated method stub
		// ¬¥√∫¬º√õ√ä√Ω¬æ√ù¬ø√¢¬ª√±√à¬°√ñ¬µ¬±√à¬Ω√è
		double offlineCost = oc.computeOfflineCostFromSource(DialogActivity.this, user.getName());
		netSpeedSP = new NetworkSpeedSP(DialogActivity.this, Constants.NET_SPEED);
		netSeaWilAP = new NetworkSearchingWillingSP(DialogActivity.this, Constants.NET_WILLING);
		double onlineCost = 200 / (1024 * netSpeedSP.getWeightSpeed())
				+ netSeaWilAP.getWillingCost(System.currentTimeMillis())
				+ onlineThrowTimeDB.getWeightTime(util.getName(), user.getName());
		/*
		 * double onlineCost = onlineThrowTimeDB.getWeightTime(util.getName(),
		 * user.getName());
		 */
		if (offlineCost < onlineCost) {
			hint.setText("SCF");
			hint.setVisibility(View.VISIBLE);
			mode = 3;
		} else {
			hint.setText("");
			hint.setVisibility(View.VISIBLE);
			mode = 4;
		}
	}

	private void OnlineSelectMode() {
		// TODO Auto-generated method stub
		presence = roster.getPresence(user.getName() + "@" + Constants.SERVER_NAME);
		if (presence.isAvailable() == true) {
			// √à√ß¬π√ª√î√ö√è√ü¬£¬¨√ñ¬±¬Ω√ì¬∑¬¢√ã√ç
			ChatManager c = con.getChatManager();
			chat = c.createChat(user.getName() + "@" + Constants.SERVER_NAME, null);
			hint.setText("");
			hint.setVisibility(View.VISIBLE);
			mode = 0;
		} else if (presence.isAvailable() == false) {
			// √à√ß¬π√ª√Ä√´√è√ü¬£¬¨√ë¬°√î√±¬µ√à¬¥√Ω¬∏√∏¬∑√æ√é√±√Ü√∑√ñ¬±¬Ω√ì¬∑¬¢√ã√ç¬£¬¨¬ª¬π√ä√á√ë¬°√î√±√à√É√Ü√§√ã√ª√î√ö√è√ü√ì√É¬ª¬ßSCF
			// ¬ø¬™√Ü√¥√í¬ª¬∏√∂√è√ü¬≥√å¬£¬¨√î√ö√è√ü¬≥√å¬∑¬¢√ã√ç¬±¬®√é√Ñ1
			pd = ProgressDialog.show(DialogActivity.this, "loading", "");
			new Thread(new Runnable() {
				@Override
				public void run() {
					receiveResult();
					handler.sendEmptyMessage(mode);
				}
			}).start();
		}
	}

	private void receiveResult() {
		BeginAskOnlinePacket beginAskOnlinePacket = new BeginAskOnlinePacket();
		beginAskOnlinePacket.setThrowid(throwid);
		beginAskOnlinePacket.setDestination(user.getName());
		beginAskOnlinePacket.setSize("200/1024");// ¬∞¬¥√í¬ª√å√µ√è√ª√è¬¢100¬∏√∂√ó√ñ√Ä¬¥√ã√£
		XmppTool.getConnection().sendPacket(beginAskOnlinePacket);
		// √î√ögetMessage√ñ√ê¬Ω√ì√ä√ï¬Ω√°¬π√ª,¬Ω√ì√ä√ï¬µ¬Ω¬Ω√°¬π√ª¬∫√≥¬£¬¨√ë¬≠¬ª¬∑¬Ω√°√ä√∏
		int count = 1;
		while (flag && count < 20) {
			try {
				count++;
				Thread.sleep(500);
			} catch (InterruptedException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
			}
			if (count == 20) {// √à√ß¬π√ª√ä√á√í√≤√é¬™¬≥¬¨√ä¬±√Å√ã
				mode = 3;
			}
		}
	}

	Handler handler = new Handler() {
		@Override
		public void handleMessage(Message msg) {
			super.handleMessage(msg);
			switch (msg.what) {
			case 1: // √ì√â¬∑√æ√é√±√Ü√∑√ñ¬±¬Ω√ì¬∑¬¢√ã√ç
				pd.dismiss();// ¬π√ò¬±√ïProgressDialog
				hint.setText("");
				hint.setVisibility(View.VISIBLE);
				break;
			case 2: // √ì√â¬∑√æ√é√±√Ü√∑¬º√§¬Ω√ì¬∑¬¢√ã√ç
				pd.dismiss();// ¬π√ò¬±√ïProgressDialog
				hint.setText("");
				hint.setVisibility(View.VISIBLE);
				break;
			case 3: // √ì√âSCF¬∑¬¢√ã√ç
				hint.setText("SCF");
				hint.setVisibility(View.VISIBLE);
				pd.dismiss();// ¬π√ò¬±√ïProgressDialog
				break;
			case Constants.UPDATE_LIST:// ¬∏√º√ê√Ç√Å√Ñ√å√¨√ê√Ö√è¬¢
				mAdapter.notifyDataSetChanged();
				break;
			default:
				break;
			}
		}
	};

	/**
	 * ¬µ√£¬ª√∑¬∑¬¢√ã√ç√ñ¬Æ¬∫√≥¬µ√Ñ√è√¨√ì¬¶¬£¬¨√Ö√ê¬∂√è√ä√á¬π√£¬≤¬•¬ª¬π√ä√á¬µ¬•¬≤¬•¬£¬ª¬∂√î√ì√ö¬µ¬•¬≤¬•¬∏√π¬æ√ùmode¬£¬¨¬∑¬¢√ã√ç¬≤¬ª√ç¬¨¬µ√Ñ¬±¬®√é√Ñ
	 *
	 */
	class SendListener implements OnClickListener {
		public void onClick(View v) {
			contenttext = content.getText().toString();
			throwid = Integer.parseInt(throwid) + 1 + "";
			if (contenttext.length() > 0) {
				// ¬∂√î¬ª¬∞¬ø√≤√è√î√ä¬æ¬∂√î¬ª¬∞
				ChatMsgEntity entity = new ChatMsgEntity(user.getName(), MyDate.getDateEN(), contenttext, util.getImg(),
						false);
				entity.setName(util.getName());
				entity.setDate(MyDate.getDateEN());
				entity.setMessage(contenttext);
				entity.setImg(util.getImg());
				entity.setMsgType(false);
				messageDB.saveMsg(util.getName(), entity);
				mDataArrays.add(entity);
				mAdapter.notifyDataSetChanged();// √ç¬®√ñ¬™ListView¬£¬¨√ä√Ω¬æ√ù√í√ë¬∑¬¢√â√∫¬∏√Ñ¬±√§
				content.setText("");// √á√•¬ø√ï¬±√†¬º¬≠¬ø√≤√ä√Ω¬æ√ù
				mListView.setSelection(mListView.getCount() - 1);// ¬∑¬¢√ã√ç√í¬ª√å√µ√è√ª√è¬¢√ä¬±¬£¬¨ListView√è√î√ä¬æ√ë¬°√î√±√ó√Æ¬∫√≥√í¬ª√è√Æ

				// ¬∑¬¢√ã√ç¬∏√∏¬∑√æ√é√±√Ü√∑
				if (user.getName().equals("¬π√£¬≤¬•√î√ö√è√ü¬∫√É√ì√ë")) // ¬π√£¬≤¬•
				{
					Collection<RosterEntry> rosterEntry = roster.getEntries();
					Iterator<RosterEntry> i = rosterEntry.iterator();
					ChatManager c = con.getChatManager();
					while (i.hasNext()) {
						String name = i.next().getName();
						chat = c.createChat(name + "@" + Constants.SERVER_NAME, null);
						try {
							chat.sendMessage(contenttext);
						} catch (XMPPException e) {
							e.printStackTrace();
						}
					}
				} else if (user.isCom() == true) // √ó√©¬≤¬•
				{
					try {
						muc.sendMessage(contenttext);
					} catch (XMPPException e) {
						// TODO Auto-generated catch block
						e.printStackTrace();
					}
				} else // ¬µ¬•¬≤¬•
				{
					if (connected && mode == 0) {
						// √ï√Ω¬≥¬£¬∑¬¢√ã√ç
						try {
							/*
							 * hint.setText("√å√°√ä¬æ¬£¬∫√è√ª√è¬¢√ç¬®¬π√Ω¬∑√æ√é√±√Ü√∑¬∑¬¢√ã√ç");
							 * hint.setVisibility(View.VISIBLE); ChatManager c =
							 * con.getChatManager(); chat =
							 * c.createChat(user.getName() + "@" +
							 * Constants.SERVER_NAME, null);
							 * chat.sendMessage(contenttext);
							 */

							DirectScfPacket directScfPacket = new DirectScfPacket();
							directScfPacket.setThrowid(throwid);
							directScfPacket.setSource(util.getName());
							String remoteName = user.getName();
							int atIndex = remoteName.indexOf(WqtConstants.SYMBOL_SPILT);
							if (atIndex != -1) {
								directScfPacket.setDestination(remoteName.substring(0, atIndex));
							} else {
								directScfPacket.setDestination(remoteName);
							}
							// directScfPacket.setDestination(user.getName());
							directScfPacket.setValue(contenttext);
							directScfPacket.setStarttime(MyDate.getDateEN());
							directScfPacket.setMsgcontent(contenttext);
							directScfPacket.setLife("3600000 * 24");
							XmppTool.getConnection().sendPacket(directScfPacket);

							// test
							/*
							 * Log.d("send msg", "by offline method");
							 * OfflineMsgEntity offlineMsgEntity=new
							 * OfflineMsgEntity();
							 * offlineMsgEntity.setSource(util.getName());
							 * String dstName=user.getName(); String
							 * destination=null; int
							 * onIndex=dstName.indexOf(WqtConstants.SYMBOL_SPILT
							 * ); if(onIndex==-1){ destination=dstName; }else{
							 * destination=dstName.substring(0, onIndex); }
							 * offlineMsgEntity.setDestnation(destination);
							 * 
							 * offlineMsgEntity.setDate(directScfPacket.
							 * getStarttime());
							 * offlineMsgEntity.setMsgContent(contenttext);
							 * SendAPI.sendOfflineMessageWithoutLink(
							 * DialogActivity.this, offlineMsgEntity);
							 */
						} catch (Exception e) {
							e.printStackTrace();
						}
					} else if (!connected) {
						/*
						 * double offlineCost =
						 * oc.computeOfflineCostFromSource(DialogActivity.this,
						 * user.getName()); netSpeedSP = new
						 * NetworkSpeedSP(DialogActivity.this,
						 * Constants.NET_SPEED); netSeaWilAP = new
						 * NetworkSearchingWillingSP(DialogActivity.this,
						 * Constants.NET_WILLING); onlineThrowTimeDB = new
						 * OnlineThrowTimeDB(DialogActivity.this); //
						 * netSpeedSP.getWeightSpeed()√é¬™0¬£¬¨¬ª√°¬±¬®√í√¨¬≥¬£ // double
						 * onlineCost = getMessageLength(contenttext) / //
						 * netSpeedSP.getWeightSpeed() // + //
						 * netSeaWilAP.getWillingCost(System.currentTimeMillis()
						 * ) // +
						 * onlineThrowTimeDB.getWeightTime(util.getName(), //
						 * user.getName()); double onlineCost =
						 * netSeaWilAP.getWillingCost(System.currentTimeMillis()
						 * ) + onlineThrowTimeDB.getWeightTime(util.getName(),
						 * user.getName()); // onlineCost√ñ¬µ√é¬™¬∏¬∫¬£¬ø¬£¬ø¬£¬ø¬£¬ø
						 * onlineCost = 10; if (onlineCost < offlineCost) {
						 * hint.setText("√å√°√ä¬æ¬£¬∫√è√ª√è¬¢√î√ö√ç√∏√Ç√ß¬ª√ñ¬∏¬¥√ä¬±¬∑¬¢√ã√ç");
						 * hint.setVisibility(View.VISIBLE); //
						 * Toast.makeText(DialogActivity.this, "save in DB", //
						 * Toast.LENGTH_LONG).show();
						 * bufferDB.insertMessage(util.getName(),
						 * util.getName(), user.getName(),
						 * System.currentTimeMillis(), contenttext.hashCode(),
						 * 3600000 * 24, contenttext, ""); } else {
						 * hint.setText("√å√°√ä¬æ¬£¬∫√è√ª√è¬¢√ç¬®¬π√ΩSCF¬∑¬¢√ã√ç");
						 * hint.setVisibility(View.VISIBLE); //
						 * Toast.makeText(DialogActivity.this, "select scf", //
						 * Toast.LENGTH_LONG).show();
						 * offlineMessageDB.insertMessage(util.getName(),
						 * util.getName(), user.getName(),
						 * System.currentTimeMillis(), contenttext.hashCode(),
						 * 3600000 * 24, contenttext, "",
						 * getMessageLength(contenttext), "null");
						 * waitToRecDB.insertData(util.getName(),
						 * user.getName(), contenttext.hashCode(),
						 * System.currentTimeMillis(), 1);
						 * myApplication.setIsSendOn(true); }
						 */
						hint.setText("SCF");
						hint.setVisibility(View.VISIBLE);
						Log.d("send msg", "by offline method");
						OfflineMsgEntity offlineMsgEntity = new OfflineMsgEntity();
						offlineMsgEntity.setSource(util.getName());
						String destination = null;
						String dstName = user.getName();
						int atIndex = dstName.indexOf(WqtConstants.SYMBOL_SPILT);
						if (atIndex == -1) {
							destination = dstName;
						} else {
							destination = dstName.substring(0, atIndex);
						}
						offlineMsgEntity.setDestnation(destination);
						offlineMsgEntity.setDate(MyDate.getDateEN());
						offlineMsgEntity.setMsgContent(contenttext);
						SendAPI.sendOfflineMessageWithoutLink(DialogActivity.this, offlineMsgEntity);
					} // ¬∑¬¢√ã√ç¬∑¬Ω√Å¬¨¬Ω√ì¬µ¬Ω¬∑√æ√é√±√Ü√∑
					else {
						// Toast.makeText(DialogActivity.this, "get online cost
						// from server", Toast.LENGTH_LONG).show();
						/*
						 * BeginAskOnlinePacket beginAskOnlinePacket = new
						 * BeginAskOnlinePacket();
						 * beginAskOnlinePacket.setThrowid(throwid);
						 * beginAskOnlinePacket.setDestination(user.getName());
						 * beginAskOnlinePacket.setSize("200/1024");//
						 * ¬∞¬¥√í¬ª√å√µ√è√ª√è¬¢100¬∏√∂√ó√ñ√Ä¬¥√ã√£
						 * XmppTool.getConnection().sendPacket(
						 * beginAskOnlinePacket);
						 */
					}
					// switch (mode) {
					// case 0:
					// try {
					// // ¬∑¬¢√ã√ç√ì√Ø√í√¥¬£¬¨¬º√ì√à√´type¬£¬¨¬∑√¢√ó¬∞√é¬™json
					// chat.sendMessage(contenttext);
					// } catch (XMPPException e) {
					// e.printStackTrace();
					// }
					// break;
					// case 1:
					// // ¬∑¬¢√ã√ç¬∏√∏¬∑√æ√é√±√Ü√∑¬£¬¨¬∑√æ√é√±√Ü√∑√ñ¬±¬Ω√ì¬∑¬¢√ã√ç¬£¬®¬±¬®√é√Ñ5¬£¬©
					// DirectScfPacket directScfPacket = new DirectScfPacket();
					// directScfPacket.setThrowid(throwid);
					// directScfPacket.setSource(util.getName());
					// directScfPacket.setDestination(user.getName());
					// directScfPacket.setValue(contenttext);
					// directScfPacket.setStarttime(MyDate.getDateLong());
					// directScfPacket.setLife("3600000 * 24");
					// XmppTool.getConnection().sendPacket(directScfPacket);
					// waitToRecDB.insertData(util.getName(), user.getName(),
					// Integer.parseInt(throwid),
					// MyDate.getDateLong(), 0);
					// break;
					// case 2:
					// // ¬∑¬¢√ã√ç¬∏√∏¬∑√æ√é√±√Ü√∑¬£¬¨¬∑√æ√é√±√Ü√∑√ñ√ê√ó¬™¬£¬®¬±¬®√é√Ñ6¬£¬©
					// ForwardScfPacket forwardScfPacket = new
					// ForwardScfPacket();
					// forwardScfPacket.setThrowid(throwid);
					// forwardScfPacket.setSource(util.getName());
					// forwardScfPacket.setDestination(user.getName());
					// forwardScfPacket.setForwarder(forwarder);
					// forwardScfPacket.setValue(contenttext);
					// forwardScfPacket.setStarttime(MyDate.getDateLong());
					// forwardScfPacket.setLife("3600000 * 24");
					// forwardScfPacket.addPass(util.getName());
					// XmppTool.getConnection().sendPacket(forwardScfPacket);
					// waitToRecDB.insertData(util.getName(), user.getName(),
					// Integer.parseInt(throwid),
					// MyDate.getDateLong(), 0);
					// break;
					// case 3: {
					// offlineMessageDB.insertMessage(util.getName(),
					// util.getName(), user.getName(),
					// System.currentTimeMillis(),
					// Integer.parseInt(throwid),
					// 3600000 * 24,
					// contenttext, util.getName(), 200/1024, "null");
					// waitToRecDB.insertData(util.getName(), user.getName(),
					// contenttext.hashCode(),
					// System.currentTimeMillis(), 1);
					// myApplication.setIsSendOn(true);
					// break;
					// }
					// case 4: {
					// //¬ª¬∫¬¥√¶√î√ö√ä√Ω¬æ√ù¬ø√¢√ñ√ê
					// ArrayList<String> passList = new ArrayList<String>();
					// passList.add(util.getName());
					// BufferMsgEntity bufEntity = new BufferMsgEntity(
					// throwid, user.getName(), util.getName(),"100",
					// MyDate.getDateEN(), contenttext,passList);
					// bufferDB.insertMessage(util.getName(), bufEntity);
					// waitToRecDB.insertData(util.getName(), user.getName(),
					// Integer.parseInt(throwid),
					// MyDate.getDateLong(), 0);
					// break;
					// }
					// default:
					// break;
					// }
				}
			}
		}
	}

	/**
	 * ¬∑¬µ¬ª√ò¬£¬¨¬π√ò¬±√ï¬¥√ã√í¬≥√É√¶
	 *
	 */

	class BackListener implements OnClickListener {
		public void onClick(View v) {
			finish();
		}
	}

	/**
	 * ¬ª√°√í√©√ä√í√è√ª√è¬¢¬º√†√å√Ω√Ä√†
	 * 
	 */
	public class multiListener implements PacketListener {
		@Override
		public void processPacket(org.jivesoftware.smack.packet.Packet packet) {
			org.jivesoftware.smack.packet.Message message = (org.jivesoftware.smack.packet.Message) packet; // ¬Ω√ì√ä√ï√Ä¬¥√ó√î√Å√Ñ√å√¨√ä√í¬µ√Ñ√Å√Ñ√å√¨√ê√Ö√è¬¢
			String body = message.getBody();
			String from = StringUtils.parseResource(message.getFrom());
			String fromRoomName = StringUtils.parseName(message.getFrom());
			if (!from.equals(util.getName())) // ¬∫√∂√Ç√î√ó√î¬º¬∫√Ä¬¥¬µ√Ñ√è√ª√è¬¢
			{
				ChatMsgEntity entity = new ChatMsgEntity(from, MyDate.getDateEN(), message.getBody(), util.getImg(),
						true);
				if (fromRoomName.contains(user.getName())) {
					messageDB.saveMsg(fromRoomName, entity);
					mDataArrays.add(entity);
					mAdapter.notifyDataSetChanged();
					mListView.setSelection(mListView.getCount() - 1);
				} else {
					messageDB.saveMsg(fromRoomName, entity);// ¬±¬£¬¥√¶¬µ¬Ω√ä√Ω¬æ√ù¬ø√¢
					Toast.makeText(DialogActivity.this,
							"√Ñ√∫√ì√ê√ê√Ç¬µ√Ñ√è√ª√è¬¢√Ä¬¥√ó√î¬£¬∫" + message.getFrom() + ":" + message.getBody(), 0).show();// √Ü√§√ã√ª¬∫√É√ì√ë¬µ√Ñ√è√ª√è¬¢¬£¬¨¬æ√ç√è√à√å√°√ä¬æ¬£¬¨¬≤¬¢¬±¬£¬¥√¶¬µ¬Ω√ä√Ω¬æ√ù¬ø√¢
				}
			}
		}
	}

	/**
	 * ¬Ω√ì√ä√ïFriendActivity¬π√£¬≤¬•¬π√Ω√Ä¬¥¬µ√Ñ√è√ª√è¬¢
	 * ¬∫√É√ì√ë√è√ª√è¬¢¬µ√Ñ¬º√†√å√Ω¬∑√Ö¬µ¬ΩFriendActivity√ñ√ê¬£¬¨√ì√ê√è√ª√è¬¢¬æ√ç¬∑√Ö¬µ¬Ω√ä√Ω¬æ√ù¬ø√¢√ñ√ê¬£¬ª
	 * √ì√É¬π√£¬≤¬•√ç¬®√ñ¬™Dialog√ä√á¬∑√±√ê√®√í¬™√è√î√ä¬æ
	 */
	private BroadcastReceiver MsgReceiver = new BroadcastReceiver() {

		@Override
		public void onReceive(Context context, Intent intent) {
			// TODO Auto-generated method stub

			ChatMsgEntity entity = (ChatMsgEntity) intent.getSerializableExtra(Constants.NORMAL_MSGKEY);
			Log.d("onReceive", entity.toString());
			String name = null;
			String userName = user.getName();
			int atIndex = userName.indexOf(WqtConstants.SYMBOL_SPILT);
			if (atIndex == -1) {
				name = userName;
			} else {
				name = userName.substring(0, atIndex);
			}
			if (entity.getMessage() != null && entity.getName().contains(name)) {
				mDataArrays.add(entity);
				mAdapter.notifyDataSetChanged();
			}

		}
	};

	@Override
	public void onStart() {// √î√östart¬∑¬Ω¬∑¬®√ñ√ê√ó¬¢¬≤√°¬π√£¬≤¬•¬Ω√ì√ä√ï√ï√ü
		super.onStart();
		IntentFilter intentFilter = new IntentFilter();
		intentFilter.addAction(Constants.NORMAL_ACTION);
		registerReceiver(MsgReceiver, intentFilter);// √ó¬¢¬≤√°¬Ω√ì√ä√ú√ï√Ω¬≥¬£√è√ª√è¬¢¬π√£¬≤¬•
	}

	@Override
	protected void onDestroy() {
		super.onDestroy();
		messageDB.close();
		unregisterReceiver(MsgReceiver);// √ó¬¢√è√∫¬π√£¬≤¬•
		unregisterReceiver(networkchangeReceiver);
	}

	private boolean isNetworkAvailable() {
		ConnectivityManager mgr = (ConnectivityManager) getApplicationContext()
				.getSystemService(Context.CONNECTIVITY_SERVICE);
		NetworkInfo[] info = mgr.getAllNetworkInfo();
		if (info != null) {
			for (int i = 0; i < info.length; i++) {
				if (info[i].getState() == NetworkInfo.State.CONNECTED) {
					return true;
				}
			}
		}
		return false;
	}

	// **¬¥¬¶√Ä√≠¬ª√¨¬∫√è√ä¬Ω√è√Ç¬µ√Ñ√Ä¬©√ï¬πxmpp¬±¬®√é√Ñ¬°¬¢
	// **¬Ω√ì√ä√ï√ä√á√î√öFriendActivity√ñ√ê¬µ√ÑMessageLisener√ñ√ê¬£¬¨
	// **¬Ω√ì√ä√ï¬µ¬Ω¬∫√≥¬∑¬¢√ã√ç¬π√£¬≤¬•¬£¬¨¬∏√∏MainService¬∫√çBaseActivity√ñ√ê¬µ√ÑgetMessage¬Ω√∏√ê√ê¬¥¬¶√Ä√≠

	@Override
	public void getMessage(String msg) {
		// TODO Auto-generated method stub
		try {
			JSONObject jsonObj = new JSONObject(msg);
			switch ((String) jsonObj.get(Constants.PACKET_TYPE)) {
			case Constants.RESPONSE_ONLINECOST:
				Toast.makeText(DialogActivity.this, "√ä√ï¬µ¬ΩresponseOnlineCost¬±¬®√é√Ñ¬£¬¨√î√öDialogActivity√ñ√ê¬¥¬¶√Ä√≠¬°¬£",
						Toast.LENGTH_LONG).show();
				// System.out.println("eeeeeeeeeeeee");
				// logPrint("√ä√ï¬µ¬ΩresponseOnlineCost¬±¬®√é√Ñ¬£¬¨√î√öDialogActivity√ñ√ê¬¥¬¶√Ä√≠:
				// " +
				// jsonObj.toString());
				double offlineCost = oc.computeOfflineCostFromSource(DialogActivity.this, user.getName());
				double onlineCost = jsonObj.getDouble("value");
				if (offlineCost * 10 < onlineCost) {
					// System.out.println("wwwwwwwwww");
					// logPrint("√î√ödialogActivity√ñ√ê¬æ¬≠¬±√à¬Ω√è√ä¬π√ì√Éoffline¬∑¬Ω√ä¬Ω¬°¬£");
					Toast.makeText(DialogActivity.this, "√î√ödialogActivity√ñ√ê¬æ¬≠¬±√à¬Ω√è√ä¬π√ì√Éoffline¬∑¬Ω√ä¬Ω", Toast.LENGTH_LONG)
							.show();
					offlineMessageDB.insertMessage(util.getName(), util.getName(), user.getName(),
							System.currentTimeMillis(), Integer.parseInt(throwid), 3600000 * 2, contenttext, "",
							System.currentTimeMillis(), "null");
					waitToRecDB.insertData(util.getName(), user.getName(), contenttext.hashCode(),
							System.currentTimeMillis(), 1);
					logPrint("¬¥¬¶√Ä√≠√ç√™waitToRecDB¬µ√Ñ¬≤√ô√ó√∑¬°¬£");
					myApplication.setIsSendOn(true);
				} else {
					// System.out.println("dddddddddd");
					// Toast.makeText(DialogActivity.this,
					// "√î√ödialogActivity√ñ√ê¬æ¬≠¬±√à¬Ω√è√ä¬π√ì√Éonline¬∑¬Ω√ä¬Ω.",
					// Toast.LENGTH_LONG).show();
					// logPrint("√î√ödialogActivity√ñ√ê¬æ¬≠¬±√à¬Ω√è√ä¬π√ì√Éonline¬∑¬Ω√ä¬Ω¬°¬£");
					Toast.makeText(DialogActivity.this, "type" + jsonObj.getInt("type"), Toast.LENGTH_LONG).show();
					int type = jsonObj.getInt("type");
					waitToRecDB.insertData(util.getName(), user.getName(), contenttext.hashCode(),
							System.currentTimeMillis(), 0);
					if (type == 1) {
						// System.out.println("QQQQQQQQQQ");
						// logPrint("√î√ödialogActivity√ñ√ê¬∑¬¢√ã√çdirectSCF_jso¬∞√º¬°¬£");
						// √è√≤¬∑√æ√é√±√Ü√∑¬∑¬¢√ã√çdirectSCF
						// System.out.println("source:" + util.getName() +"
						// destination:" + user.getName() + " context:" +
						// contenttext);
						DirectScfPacket directScfPacket = new DirectScfPacket();
						directScfPacket.setThrowid(throwid);
						directScfPacket.setSource(util.getName());
						directScfPacket.setDestination(user.getName());
						directScfPacket.setValue(contenttext);
						directScfPacket.setStarttime(MyDate.getDateEN());
						directScfPacket.setLife(3600000 * 24 + "");
						XmppTool.getConnection().sendPacket(directScfPacket);
					} else {
						// System.out.println("OOOOOOOOOOOO");
						// logPrint("√î√ödialogActivity√ñ√ê¬∑¬¢√ã√çforwardSCF_jso¬∞√º¬°¬£");
						ForwardScfPacket forwardScfPacket = new ForwardScfPacket();
						forwardScfPacket.setThrowid(throwid);
						forwardScfPacket.setSource(util.getName());
						forwardScfPacket.setDestination(user.getName());
						forwardScfPacket.setValue(contenttext);
						forwardScfPacket.setStarttime(System.currentTimeMillis());
						forwardScfPacket.setLife(3600000 * 24 + "");
						forwardScfPacket.setForwarder(jsonObj.getString("forwarder"));
						forwardScfPacket.addPass(util.getName());
						XmppTool.getConnection().sendPacket(forwardScfPacket);

					}
				}
				break;
			case Constants.DIRECT_SCF:
				Log.d("received a DIRECT_SCF message", jsonObj.toString());
				String source = jsonObj.getString("source");
				String destination = jsonObj.getString("destination");
				String date = jsonObj.getString("starttime");
				String msgcontent = jsonObj.getString("msgcontent");
				if (destination.equals(util.getName())) {
					// is my message
					ChatMsgEntity chatMsgEntity = new ChatMsgEntity();
					chatMsgEntity.setName(source);
					chatMsgEntity.setMessage(msgcontent);
					chatMsgEntity.setDate(date);
					chatMsgEntity.setImg(util.getImg());
					chatMsgEntity.setMsgType(true);
					messageDB.saveMsg(util.getName(), chatMsgEntity);
					mDataArrays.add(chatMsgEntity);
					mAdapter.notifyDataSetChanged();
				} else {
					// offline send
				}

				break;
			default:
				;
			}
		} catch (Exception e) {
			e.printStackTrace();
		}

	}

	public short getMessageLength(String message) {
		return (short) message.getBytes().length;
	}

	// √Ñ√ö¬≤¬ø√Ä√†¬£¬¨¬º√å¬≥√êBroadcastReceiver¬£¬¨√É¬ø¬¥√é√ç√∏√Ç√ß√ó¬¥√å¬¨¬±√§¬ª¬Ø¬£¬¨¬ª√°√ñ¬¥√ê√êonReceive
	class NetworkchangeReceiver extends BroadcastReceiver {

		@Override
		public void onReceive(Context context, Intent intent) {
			// √ç√∏√Ç√ß√ó¬¥√å¬¨¬±√§¬ª¬Ø√ä¬±¬£¬¨¬Ω√∏√à√´isConnect√Ö√ê¬∂√è√ä√á√ç√∏√Ç√ß√Å¬¨¬Ω√ì¬ª¬π√ä√á¬∂√è¬ø¬™
			isConnect();
		}

	}

	/**
	 * ¬º√¨¬≤√©√ç√∏√Ç√ß√ó¬¥√å¬¨¬£¬¨√É¬ª√ì√ê√ç√∏√Ç√ß√ä¬±√å√°√ä¬æ√ì√É¬ª¬ß√ç√∏√Ç√ß¬≤¬ª¬ø√â√ì√É¬£¬¨ ¬∑¬¢√ã√ç√ä¬±¬¥√¶√ä√Ω¬æ√ù¬ø√¢√ñ√ê¬£¬¨√Å¬™√ç√∏√ä¬±¬∫√≤¬∑¬¢
	 */
	private void isConnect() {
		// ¬ª√±√à¬°√ä√ñ¬ª√∫√ã√π√ì√ê√Å¬¨¬Ω√ì¬π√ú√Ä√≠¬∂√î√è√≥¬£¬®¬∞√º√Ä¬®¬∂√îwi-fi,net¬µ√à√Å¬¨¬Ω√ì¬µ√Ñ¬π√ú√Ä√≠¬£¬©
		try {
			ConnectivityManager connectivity = (ConnectivityManager) this.getSystemService(this.CONNECTIVITY_SERVICE);
			if (connectivity != null) {
				// ¬ª√±√à¬°√ç√∏√Ç√ß√Å¬¨¬Ω√ì¬π√ú√Ä√≠¬µ√Ñ¬∂√î√è√≥
				NetworkInfo info = connectivity.getActiveNetworkInfo();
				if (info != null && info.isConnected()) {
					// √í√ë¬æ¬≠√Å¬¨¬Ω√ì
					if (info.getState() == NetworkInfo.State.CONNECTED && XmppTool.getConnection().isConnected()) {
						connected = true;
						con = XmppTool.getConnection();
						roster = con.getRoster();
						if (user.getName().contains("@")) {
							presence = roster.getPresence(user.getName());
						} else {
							presence = roster.getPresence(user.getName() + "@" + Constants.SERVER_NAME);
						}
						if (presence.isAvailable() == true) {
							// √à√ß¬π√ª√î√ö√è√ü¬£¬¨√ñ¬±¬Ω√ì¬∑¬¢√ã√ç
							ChatManager c = con.getChatManager();
							if (user.getName().contains("@")) {
								chat = c.createChat(user.getName(), null);
							} else {
								chat = c.createChat(user.getName() + "@" + Constants.SERVER_NAME, null);
							}
							// chat = c.createChat(user.getName() + "@" +
							// Constants.SERVER_NAME, null);
							mode = 0;
						}
					} else {
						connected = false;
					}
				} else {
					// √é¬¥√Å¬¨¬Ω√ì
					connected = false;
				}
			}

		} catch (Exception e) {
			// TODO: handle exception
			Log.v("error", e.toString());
		}
		// connected= false;
	}

	// 1108 modify
	private MultiUserChat entryMultiUserChat(String roomsName, String password) {
		// TODO Auto-generated method stub
		try {
			//  π”√XMPPConnection¥¥Ω®“ª∏ˆMultiUserChat¥∞ø⁄
			MultiUserChat muc = new MultiUserChat(XmppTool.getConnection(),
					roomsName + "@conference." + XmppTool.getConnection().getServiceName());
			// ¡ƒÃÏ “∑˛ŒÒΩ´ª·æˆ∂®“™Ω” ‹µƒ¿˙ ∑º«¬º ˝¡ø
			DiscussionHistory history = new DiscussionHistory();
			history.setMaxChars(0);
			// history.setSince(new Date());
			// ”√ªßº”»Î¡ƒÃÏ “
			muc.join(util.getName(), password, history, SmackConfiguration.getPacketReplyTimeout());
			muc.addMessageListener(new multiListener());
			return muc;
		} catch (XMPPException e) {
			e.printStackTrace();
			return null;
		}
	}

}
